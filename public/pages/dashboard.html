<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard ‚Äî HealthInsight</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600&family=Poppins:wght@400;500&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#111823;
      --muted:#94a3b8;
      --primary:#7c4dff;
      --accent:#36d1dc;
      --success:#22c55e;
    }
    body{
      background:radial-gradient(1000px 600px at 80% -10%, #0f1d2e, var(--bg) 60%);
      color:#eaf6ff;
      font-family:Poppins,sans-serif;
      margin:0;
      padding:0;
    }
    .wrap{max-width:1100px;margin:40px auto;padding:0 20px}
    .card{
      background:rgba(255,255,255,0.06);
      border:1px solid #1a324a;
      border-radius:16px;
      padding:20px;
      transition:transform .2s, box-shadow .2s;
    }
    .card.clickable{cursor:pointer}
    .card.clickable:hover{
      transform:translateY(-4px);
      box-shadow:0 10px 30px rgba(54,209,220,.2);
      border-color:var(--accent);
    }
    .cta{
      background:linear-gradient(90deg,var(--accent),#0077ff);
      color:#0d1624;
      border:0;
      border-radius:10px;
      padding:12px 16px;
      font-weight:600;
      cursor:pointer;
      transition:transform .2s;
    }
    .cta:hover{transform:translateY(-2px)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-top:20px}
    .kpis{display:flex;gap:16px;flex-wrap:wrap;margin-top:16px}
    .kpi{min-width:160px;padding:16px;border-radius:12px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08)}
    .muted{opacity:.85;color:var(--muted)}
    nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .ghost{
      background:transparent;
      border:1px solid #1a324a;
      color:#eaf6ff;
      border-radius:10px;
      padding:10px 14px;
      font-weight:600;
      cursor:pointer;
    }
    .badge{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
    }
    .badge.low{background:rgba(34,197,94,.2);color:#22c55e}
    .badge.medium{background:rgba(251,191,36,.2);color:#fbbf24}
    .badge.high{background:rgba(239,68,68,.2);color:#ef4444}
    .badge.pending{background:rgba(148,163,184,.2);color:var(--muted)}
    h3{margin:0 0 8px;font-size:1.1rem}
    .score{font-size:2rem;font-weight:700;margin:8px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <nav>
      <h1 style="margin:0;font-family:'Space Grotesk',sans-serif">üè• Health Dashboard</h1>
      <button id="logoutBtn" class="ghost">Esci</button>
    </nav>

    <div class="card" style="display:flex;justify-content:space-between;align-items:center;gap:24px;flex-wrap:wrap">
      <div>
        <h2 style="margin:0;font-family:'Space Grotesk',sans-serif">Ciao, <span id="userName">Utente</span></h2>
        <p id="heroText" class="muted" style="margin:.4rem 0 0">Benvenuto nella tua area personale.</p>
      </div>
      <button id="startBtn" class="cta">Inizia/Riprendi questionari</button>
    </div>

    <div id="content">
      <div class="grid" style="grid-template-columns:1fr 1fr;gap:20px;margin-top:20px">
        <div class="card">
          <h3>üìä Progress</h3>
          <div class="kpis">
            <div class="kpi">
              <div class="muted">Macroaree completate</div>
              <div id="kpiCompleted" style="font-size:1.6rem;font-weight:700">0 / 10</div>
            </div>
            <div class="kpi">
              <div class="muted">Stato</div>
              <div id="kpiStatus" style="font-size:1.1rem;font-weight:600">In corso</div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>üìà Score complessivo</h3>
          <canvas id="radarAll" height="260"></canvas>
        </div>
      </div>

      <div class="card" style="margin-top:20px">
        <h3>üî¨ Le tue macroaree</h3>
        <div id="areasList" class="grid"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const SUPABASE_URL = "https://dcdccwtkblubmdolkqey.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRjZGNjd3RrYmx1Ym1kb2xrcWV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3Mzk4MzksImV4cCI6MjA3NzMxNTgzOX0.v_iuUfnW7CBi0SP0VOzKCk_iRrGKYsEqaSoM3Exz1zo";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const MacroFlow = [
      "genetica_epigenetica_storiafamiliare",
      "dati_clinici_biochimici",
      "imaging_funzione",
      "segni_vitali_monitoraggio",
      "attivita_stile_vita",
      "nutrizione_idratazione",
      "sonno_ritmi",
      "funzioni_cognitive",
      "salute_mentale",
      "esposizioni_ambientali"
    ];

    const MacroLabels = {
      "genetica_epigenetica_storiafamiliare": "üß¨ Genetica & Storia Familiare",
      "dati_clinici_biochimici": "ü©∫ Dati Clinici & Biochimici",
      "imaging_funzione": "üì∑ Imaging & Valutazioni",
      "segni_vitali_monitoraggio": "üíì Segni Vitali",
      "attivita_stile_vita": "üèÉ Attivit√† & Stile di Vita",
      "nutrizione_idratazione": "ü•ó Nutrizione & Idratazione",
      "sonno_ritmi": "üò¥ Sonno & Ritmi Circadiani",
      "funzioni_cognitive": "üß† Funzioni Cognitive",
      "salute_mentale": "üíö Salute Mentale",
      "esposizioni_ambientali": "üåç Esposizioni Ambientali"
    };

    const $ = (s) => document.querySelector(s);

    async function ensureUser() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        window.location.href = '/pages/login.html';
        return null;
      }
      return user;
    }

    function getRiskClass(score) {
      if (score == null) return 'pending';
      if (score < 5) return 'low';
      if (score < 10) return 'medium';
      return 'high';
    }

    function getRiskLabel(riskClass) {
      const labels = {
        pending: 'Da compilare',
        low: 'Basso rischio',
        medium: 'Rischio moderato',
        high: 'Attenzione'
      };
      return labels[riskClass] || 'N/A';
    }

    function drawRadar(scores) {
      const labels = MacroFlow.map(slug => MacroLabels[slug] || slug);
      const ctx = $('#radarAll').getContext('2d');
      
      new Chart(ctx, {
        type: 'radar',
        data: {
          labels,
          datasets: [{
            label: 'Score (0-100)',
            data: scores,
            fill: true,
            backgroundColor: 'rgba(54,209,220,0.2)',
            borderColor: 'rgba(54,209,220,1)',
            pointBackgroundColor: 'rgba(54,209,220,1)',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: 'rgba(54,209,220,1)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            r: {
              suggestedMin: 0,
              suggestedMax: 100,
              ticks: { stepSize: 20, color: '#94a3b8' },
              grid: { color: 'rgba(255,255,255,0.1)' },
              pointLabels: { color: '#eaf6ff', font: { size: 11 } }
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }

    function renderAreasList(assessments, completedSet) {
      const list = $('#areasList');
      list.innerHTML = '';

      MacroFlow.forEach(slug => {
        const a = assessments.find(x => x.macroarea === slug);
        const completed = completedSet.has(slug);
        const score = a?.score ?? null;
        const riskClass = getRiskClass(score);

        const card = document.createElement('div');
        card.className = 'card clickable';
        card.innerHTML = `
          <h3 style="margin:0 0 12px">${MacroLabels[slug] || slug}</h3>
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
            <span class="badge ${riskClass}">${getRiskLabel(riskClass)}</span>
          </div>
          <div class="score">${score !== null ? score.toFixed(1) : '‚Äî'}</div>
          <p class="muted" style="margin:8px 0 0;font-size:0.9rem">
            ${completed ? '‚úÖ Completato' : 'üïê Da completare'}
          </p>
        `;
        
        card.addEventListener('click', () => {
          window.location.href = `/pages/macroarea/${slug}.html`;
        });

        list.appendChild(card);
      });
    }

    async function init() {
      const user = await ensureUser();
      if (!user) return;

      // Profilo
      const { data: profile } = await supabase
        .from('profiles')
        .select('nome, cognome')
        .eq('user_id', user.id)
        .single();

      $('#userName').textContent = profile?.nome || user.email.split('@')[0];

      // Progress
      const { data: progress } = await supabase
        .from('progress')
        .select('completed_macroaree, fully_completed')
        .eq('user_id', user.id)
        .single();

      const completedSet = new Set(progress?.completed_macroaree || []);
      $('#kpiCompleted').textContent = `${completedSet.size} / ${MacroFlow.length}`;
      $('#kpiStatus').textContent = progress?.fully_completed ? 'Completato ‚úÖ' : 'In corso ‚è≥';

      // Assessments
      const { data: assessments } = await supabase
        .from('assessments')
        .select('macroarea, score, completed_at')
        .eq('user_id', user.id)
        .order('completed_at', { ascending: true });

      // Radar
      const radarScores = MacroFlow.map(m => {
        const a = (assessments || []).find(x => x.macroarea === m);
        return a?.score ? Math.min(100, Math.max(0, a.score * 10)) : 0;
      });
      drawRadar(radarScores);

      // Lista
      renderAreasList(assessments || [], completedSet);

      // CTA
      $('#startBtn').addEventListener('click', () => {
        const next = MacroFlow.find(m => !completedSet.has(m)) || MacroFlow[0];
        window.location.href = `/pages/macroarea/${next}.html`;
      });

      // Logout
      $('#logoutBtn').addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.href = '/pages/login.html';
      });
    }

    init();
  </script>
</body>
</html>