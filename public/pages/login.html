<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Accedi ‚Ä¢ HealthInsight</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0c0f14;
      --panel:#121622;
      --panel-2:#0f1420;
      --ink:#e6f0ff;
      --muted:#a9b7d0;
      --brand:#8a2be2;
      --brand-2:#00c2ff;
      --ok:#28c76f;
      --err:#ff6b6b;
      --focus: 0 0 0 3px rgba(0,194,255,.25), 0 0 0 6px rgba(138,43,226,.2);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: Poppins, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 700px at 10% -10%, rgba(0,194,255,.12), transparent 60%),
                  radial-gradient(900px 600px at 110% -20%, rgba(138,43,226,.12), transparent 60%),
                  linear-gradient(180deg, var(--panel-2), var(--bg));
      color: var(--ink);
    }
    .wrap{min-height:100%; display:grid; grid-template-rows:auto 1fr auto}
    header{position:sticky; top:0; backdrop-filter:saturate(160%) blur(6px); background:rgba(12,15,20,.6); border-bottom:1px solid rgba(255,255,255,.06); z-index:20}
    .container{max-width:1080px; margin:0 auto; padding:16px 20px}
    .brand{display:flex; gap:12px; align-items:center; text-decoration:none; color:var(--ink)}
    .brand .logo{width:34px; height:34px; display:grid; place-items:center; border-radius:10px; background:linear-gradient(135deg, var(--brand), var(--brand-2)); box-shadow:0 6px 20px rgba(0,194,255,.18)}
    .brand span{font-family: Space Grotesk, Poppins, sans-serif; font-weight:700; letter-spacing:.4px}

    main{display:grid; place-items:center; padding:40px 16px}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:28px; width:100%; max-width:1080px}
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }

    .panel{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.08); border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.35)}
    .p24{padding:24px}
    .p32{padding:32px}

    h1{margin:0 0 8px; font-family: Space Grotesk, Poppins, sans-serif; font-size:30px; letter-spacing:.2px}
    p.muted{margin:0 0 22px; color:var(--muted)}

    .field{display:grid; gap:8px; margin:16px 0}
    label{font-size:14px; color:#cfe2ff}
    input[type="email"], input[type="password"]{
      width:100%; padding:14px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.12);
      background:rgba(6,10,16,.6); color:var(--ink); outline:none; transition:.15s ease; font-size:15px
    }
    input:focus{box-shadow: var(--focus); border-color: rgba(0,194,255,.45)}

    .row{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:6px}
    .remember{display:flex; align-items:center; gap:10px; color:var(--muted); font-size:13px}
    .remember input{accent-color: var(--brand)}

    .btn{appearance:none; border:0; padding:14px 16px; border-radius:12px; font-weight:600; cursor:pointer; transition:.15s ease; display:inline-flex; gap:10px; align-items:center}
    .btn-primary{background:linear-gradient(135deg, var(--brand), var(--brand-2)); color:#06101a; box-shadow:0 10px 30px rgba(0,194,255,.22)}
    .btn-primary:hover{transform: translateY(-1px)}
    .btn-primary:disabled{opacity:0.5; cursor:not-allowed; transform:none}
    .btn-ghost{background:transparent; color:var(--ink); border:1px solid rgba(255,255,255,.14)}
    .btn-ghost:hover{background:rgba(255,255,255,.04)}
    .btn-full{width:100%; justify-content:center}

    .alt{display:grid; gap:12px; margin-top:14px}
    .or{display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:10px; color:var(--muted); font-size:13px; margin:14px 0}
    .or::before, .or::after{content:""; height:1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,.16), transparent)}

    .error, .success{display:none; margin-top:10px; padding:10px 12px; border-radius:10px; font-size:14px}
    .error{background: rgba(255,107,107,.08); border:1px solid rgba(255,107,107,.35); color:#ffd6d6}
    .success{background: rgba(40,199,111,.08); border:1px solid rgba(40,199,111,.35); color:#d7ffe7}

    .illus{position:relative; overflow:hidden}
    .illus .card{height:100%;}
    .badge{display:inline-flex; gap:8px; align-items:center; padding:8px 12px; border-radius:999px; background:rgba(0,194,255,.12); border:1px solid rgba(0,194,255,.25); color:#bfefff; font-size:12px}
    .kpi{display:flex; gap:14px; flex-wrap:wrap; margin-top:18px}
    .kpi .chip{padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.03); font-size:13px; color:var(--muted)}
    .hint{font-size:12px; color:var(--muted); margin-top:10px}
    a{color:#c1d9ff}
    nav{display:flex; gap:14px}
    nav a{color:var(--muted); text-decoration:none; padding:8px 12px; border-radius:8px; transition:.2s}
    nav a:hover{color:var(--ink); background:rgba(255,255,255,.05)}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="container" style="display:flex; align-items:center; justify-content:space-between; gap:14px">
      <a class="brand" href="/index.html">
        <div class="logo">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 12c0-4.418 3.582-8 8-8" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <path d="M20 12c0 4.418-3.582 8-8 8" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <circle cx="12" cy="12" r="2.5" fill="white"/>
          </svg>
        </div>
        <span>HealthInsight</span>
      </a>
      <nav>
        <a href="/index.html">Home</a>
        <a href="/index.html#chi-siamo">Chi siamo</a>
        <a href="/index.html#contatti">Contatti</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="grid">
      <section class="panel p32">
        <h1>Accedi</h1>
        <p class="muted">Entra per continuare la compilazione dei questionari e vedere dashboard e consigli personalizzati.</p>

        <form id="loginForm" novalidate>
          <div class="field">
            <label for="email">Email</label>
            <input id="email" name="email" type="email" autocomplete="email" placeholder="es. nome@dominio.it" required />
          </div>

          <div class="field">
            <label for="password" style="display:flex; align-items:center; justify-content:space-between">
              <span>Password</span>
              <button type="button" class="btn btn-ghost" id="togglePwd" style="padding:6px 10px; font-size:12px">Mostra</button>
            </label>
            <input id="password" name="password" type="password" autocomplete="current-password" placeholder="Minimo 8 caratteri" required />
          </div>

          <div class="row">
            <label class="remember">
              <input type="checkbox" id="remember" name="remember" /> Ricordami
            </label>
            <a href="#" id="resetLink">Password dimenticata?</a>
          </div>

          <div class="error" id="errorBox" role="alert"></div>
          <div class="success" id="successBox" role="status"></div>

          <div style="margin-top:18px; display:grid; gap:10px">
            <button class="btn btn-primary btn-full" id="loginBtn" type="submit">Accedi</button>
            <button class="btn btn-ghost btn-full" id="toRegister" type="button">Crea un account</button>
          </div>

          <div class="or">oppure</div>

          <div class="alt">
            <button class="btn btn-ghost btn-full" type="button" id="googleBtn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21.35 11.1h-9.18v2.98h5.27c-.23 1.5-1.6 4.4-5.27 4.4-3.17 0-5.75-2.62-5.75-5.86s2.58-5.86 5.75-5.86c1.81 0 3.02.77 3.71 1.43l2.53-2.44C17.6 3.89 15.6 3 13.17 3 8.33 3 4.39 6.94 4.39 11.68c0 4.74 3.94 8.68 8.78 8.68 5.07 0 8.42-3.56 8.42-8.57 0-.57-.06-1.12-.16-1.69z" fill="currentColor"/></svg>
              Accedi con Google
            </button>
          </div>
        </form>
      </section>

      <aside class="panel p24 illus">
        <div class="badge">üîí Sicurezza & Privacy</div>
        <h2 style="font-family:Space Grotesk; font-size:22px; margin:10px 0 8px">Dati sanitari protetti</h2>
        <p class="muted" style="margin:0 0 14px">Crittografia end-to-end. I tuoi dati sono sempre sotto il tuo controllo.</p>
        <div class="kpi">
          <div class="chip">üõ°Ô∏è Crittografia avanzata</div>
          <div class="chip">üìä Dashboard personalizzata</div>
          <div class="chip">üìÑ Report esportabili</div>
        </div>
      </aside>
    </div>
  </main>

  <footer style="border-top:1px solid rgba(255,255,255,.08); background:rgba(12,15,20,.6)">
    <div class="container" style="display:flex; align-items:center; justify-content:space-between; gap:14px; font-size:13px; color:var(--muted); flex-wrap:wrap">
      <span>¬© <span id="year"></span> HealthInsight</span>
      <div style="display:flex; gap:12px">
        <a href="/index.html#contatti">Supporto</a>
        <a href="#">Privacy</a>
        <a href="#">Termini</a>
      </div>
    </div>
  </footer>
</div>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  // Config Supabase
  const SUPABASE_URL = "https://dcdccwtkblubmdolkqey.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRjZGNjd3RrYmx1Ym1kb2xrcWV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3Mzk4MzksImV4cCI6MjA3NzMxNTgzOX0.v_iuUfnW7CBi0SP0VOzKCk_iRrGKYsEqaSoM3Exz1zo";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true }
  });

  const $ = (s) => document.querySelector(s);
  const errorBox = $('#errorBox');
  const successBox = $('#successBox');
  const loginBtn = $('#loginBtn');

  $('#year').textContent = new Date().getFullYear();

  // Verifica sessione esistente
  (async () => {
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
      loginBtn.textContent = 'Vai alla dashboard';
      loginBtn.onclick = (e) => {
        e.preventDefault();
        window.location.href = '/pages/dashboard.html';
      };
    }
  })();

  // Toggle password
  $('#togglePwd').addEventListener('click', () => {
    const input = $('#password');
    const vis = input.type === 'password' ? 'text' : 'password';
    input.type = vis;
    $('#togglePwd').textContent = vis === 'text' ? 'Nascondi' : 'Mostra';
  });

  // Vai a registrazione
  $('#toRegister').addEventListener('click', () => {
    window.location.href = '/pages/register.html';
  });

  // Reset password
  $('#resetLink').addEventListener('click', async (e) => {
    e.preventDefault();
    const email = $('#email').value.trim();
    
    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      errorBox.style.display = 'block';
      errorBox.textContent = 'Inserisci prima una email valida nel campo sopra.';
      return;
    }

    try {
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: `${window.location.origin}/pages/reset-password.html`,
      });
      
      if (error) throw error;
      
      successBox.style.display = 'block';
      successBox.textContent = `Email di ripristino inviata a ${email}. Controlla la tua casella.`;
      errorBox.style.display = 'none';
    } catch (err) {
      errorBox.style.display = 'block';
      errorBox.textContent = err.message;
    }
  });

  // Login con Google
  $('#googleBtn').addEventListener('click', async () => {
    try {
      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: `${window.location.origin}/pages/dashboard.html`
        }
      });
      if (error) throw error;
    } catch (err) {
      errorBox.style.display = 'block';
      errorBox.textContent = err.message;
    }
  });

  // Form submit - LOGIN
  $('#loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const email = $('#email').value.trim();
    const password = $('#password').value;

    errorBox.style.display = 'none';
    successBox.style.display = 'none';

    // Validazione base
    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      errorBox.style.display = 'block';
      errorBox.textContent = 'Inserisci un\'email valida.';
      return;
    }
    if (!password || password.length < 6) {
      errorBox.style.display = 'block';
      errorBox.textContent = 'La password deve avere almeno 6 caratteri.';
      return;
    }

    loginBtn.disabled = true;
    loginBtn.textContent = 'Accesso in corso...';

    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password
      });

      if (error) throw error;

      if (!data.user) throw new Error('Accesso fallito');

      // Successo - reindirizza
      window.location.href = '/pages/dashboard.html';

    } catch (err) {
      console.error('Login error:', err);
      errorBox.style.display = 'block';
      errorBox.textContent = err.message === 'Invalid login credentials' 
        ? 'Email o password non corretti' 
        : err.message;
      loginBtn.disabled = false;
      loginBtn.textContent = 'Accedi';
    }
  });
  // Dopo il login di successo, modifica questa parte:

  if (!data.user) throw new Error('Accesso fallito');

  // Controlla il tipo di utente
  const { data: profile } = await supabase
    .from('profiles')
    .select('user_type')
    .eq('user_id', data.user.id)
    .single();

  // Redirect in base al tipo
  if (profile?.user_type === 'corporate') {
    window.location.href = '/pages/corporate/simplified-questionnaire.html';
  } else {
    window.location.href = '/pages/dashboard.html';
  }
</script>
</body>
</html>